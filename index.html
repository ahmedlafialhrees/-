<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø¯Ø±Ø¯Ø´Ø© ØµÙˆØªÙŠØ©</title>
<style>
:root{--bg:#0f1322;--panel:#141a2c;--muted:#1b2236;--stroke:#2b3550;--ink:#eaf0ff;--lav:#b79cff;--lav2:#a487ff;--gold1:#ffd76b;--gold2:#ffb224;--red1:#ff6b6b;--red2:#ff1f1f}
*{box-sizing:border-box} html,body{height:100dvh;overflow:hidden}
body{margin:0;color:var(--ink);background:linear-gradient(180deg,#0e1220,#0b0f1a);font-family:-apple-system,system-ui,"Segoe UI",Tahoma,Arial}
.screen{display:none}.screen.active{display:block}

/* Login */
.login-card{width:480px;max-width:94vw;margin:40px auto;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid var(--stroke);border-radius:18px;padding:18px 16px 24px;text-align:center;backdrop-filter:blur(10px);box-shadow:0 20px 60px rgba(0,0,0,.55)}
.login-icon{width:64px;height:64px;border-radius:16px;background:#222a3e;display:flex;align-items:center;justify-content:center;margin:6px auto 10px;font-size:28px}
.login-title{margin:0 0 12px;font-size:22px}
.label{display:block;text-align:right;font-size:13px;color:#cfd6ea;margin:10px 2px 6px}
.input{width:100%;background:var(--muted);border:1px solid var(--stroke);border-radius:12px;padding:12px 14px;font-size:16px;color:#fff;outline:none}
.btn-primary{width:100%;margin-top:14px;padding:12px 16px;border:none;border-radius:12px;background:linear-gradient(90deg,var(--lav),var(--lav2));color:#140a2b;font-weight:800;font-size:16px;cursor:pointer}
.row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.name-row{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:center}
.avatar-lg{width:56px;height:56px;border-radius:50%;overflow:hidden;border:1px solid var(--stroke);background:#0e1425;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
.avatar-lg img{width:100%;height:100%;object-fit:cover}

/* Grid */
.canvas{max-width:920px;margin:0 auto;padding:8px;display:grid;gap:8px;height:100dvh;grid-template-rows:auto 1fr auto auto}

/* Header */
.hdr{height:60px;display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--panel);border:1px solid var(--stroke);border-radius:12px}
.hdr .left,.hdr .mid,.hdr .right{display:flex;align-items:center;gap:8px}
.ib{background:#1a2236;border:1px solid var(--stroke);color:#cfd6ea;border-radius:12px;padding:8px 10px;cursor:pointer}
.badge{font-size:10px;padding:2px 8px;border-radius:999px;margin-right:6px;vertical-align:middle}
.badge.owner{background:linear-gradient(90deg,var(--gold1),var(--gold2));color:#1a1200;box-shadow:0 0 12px rgba(255,197,61,.85)}
.badge.admin{background:linear-gradient(90deg,var(--red1),var(--red2));color:#fff;box-shadow:0 0 12px rgba(255,65,65,.85)}
.avatar{width:42px;height:42px;border-radius:50%;border:1px solid var(--stroke);overflow:hidden;display:inline-flex;background:#0e1425}
.avatar img{width:100%;height:100%;object-fit:cover}

/* Messages */
.list{overflow:auto;margin:0;padding:12px;display:flex;flex-direction:column;gap:10px;background:transparent;border:none;border-radius:14px}
.msg{background:rgba(27,34,54,.35);border:1px solid rgba(43,53,80,.45);border-radius:12px;padding:8px 12px}
.msg .meta{font-size:12px;color:#cfd6ea;margin-bottom:4px}
.msg .text{font-size:15px}

/* Stage */
.stage-strip{overflow:auto;padding:10px;margin:0;background:linear-gradient(180deg,#171d30,#141a2b);border:1px solid var(--stroke);border-radius:14px}
#stagePanel.collapsed{height:0;padding:0;border:none;overflow:hidden}
#stageToggle{font-weight:700}
.slots{display:flex;align-items:flex-end;gap:10px;overflow-x:auto;padding-bottom:4px;scroll-snap-type:x mandatory}
.slot{min-width:86px;scroll-snap-align:center;text-align:center;padding:8px 6px;display:flex;flex-direction:column;align-items:center}
.lab{order:-1;margin-bottom:4px;font-size:12px;color:#dde4ff;min-height:1em}
.ped{height:12px;width:100%;border-radius:8px;background:linear-gradient(90deg,#9a7b2f,#cfa63b,#9a7b2f);box-shadow:0 4px 14px rgba(255,182,70,.30)}
.bub{width:48px;height:48px;border-radius:50%;margin:6px auto;background:#0c101a;display:flex;align-items:center;justify-content:center;border:3px solid #000;box-shadow:inset 0 0 0 2px #313a5a,0 6px 16px rgba(0,0,0,.40)}
.slot.on .bub{border-color:#d9b356;box-shadow:inset 0 0 0 2px #59461f,0 0 18px rgba(255,220,120,.65)}
.mic-img{width:68%;height:68%;object-fit:contain;filter:drop-shadow(0 3px 6px rgba(0,0,0,.45))}

/* Composer + Emoji */
.composer{position:static}
.pill{width:100%;max-width:880px;margin:0 auto;display:flex;align-items:center;gap:8px;background:#1b2236;border:1px solid var(--stroke);border-radius:999px;padding:8px 10px;position:relative}
.pill input{flex:1;background:transparent;border:none;outline:none;color:#fff;font-size:16px}
.btn-r{background:linear-gradient(90deg,var(--lav),var(--lav2));border:none;color:#140a2b;font-weight:800;border-radius:12px;padding:8px 12px;cursor:pointer}
.btn-ghost{background:transparent;border:none;color:#cfd6ea;font-size:20px;padding:6px 8px;border-radius:10px;cursor:pointer}
.chips{display:flex;gap:6px;margin-inline:6px}
.btn-chip{background:#212a43;color:#e8edff;border:1px solid var(--stroke);border-radius:10px;padding:6px 10px;font-size:12px;cursor:pointer}
.btn-chip.danger{background:#3a1d25;border-color:#5c2430;color:#ffb7b7}

/* Emoji popover (Ù…Ø¹Ø¯Ù‘Ù„ Ù„Ù„Ø¬ÙˆØ§Ù„) */
.popover{
  position:fixed;       /* Ø¨Ø¯Ù‘Ù„Ù†Ø§Ù‡Ø§ Ù„ÙÙˆÙ‚ ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± */
  bottom:90px;          /* Ø£Ø¹Ù„Ù‰ Ø´Ø±ÙŠØ· Ø§Ù„ÙƒØªØ§Ø¨Ø© */
  right:12px;
  background:#171d2e;
  border:1px solid var(--stroke);
  border-radius:12px;
  padding:8px;
  display:none;
  box-shadow:0 20px 50px rgba(0,0,0,.5);
  z-index:9999;
}
.popover.show{display:grid}
#emojiPanel{grid-template-columns:repeat(8,28px);gap:6px}
#emojiPanel button{background:#1b2236;border:1px solid var(--stroke);border-radius:8px;font-size:18px;padding:4px}

/* Responsive */
@media (max-width:520px){.row-2{grid-template-columns:1fr}}
</style>
</head>
<body>

<!-- Login -->
<section id="login" class="screen active">
  <div class="login-card">
    <div class="login-icon">ğŸ§</div>
    <h1 class="login-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>

    <label class="label">Ø§Ø³Ù…Ùƒ ÙˆØµÙˆØ±ØªÙƒ</label>
    <div class="name-row">
      <label class="avatar-lg" title="Ø§Ø®ØªØ± ØµÙˆØ±Ø©">
        <input id="loginAvatar" type="file" accept="image/*" hidden>
        <img id="loginAvatarImg" src="https://i.ibb.co/4St3gqK/user.png" alt="avatar">
      </label>
      <input id="displayName" class="input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ (Ù„Ù„Ø¹Ø¶Ùˆ Ù…Ù…ÙƒÙ† ØªØªØ±ÙƒÙ‡ ÙØ§Ø¶ÙŠ)">
    </div>

    <label class="label">Ø§Ù„Ø¯ÙˆØ±</label>
    <select id="role" class="input">
      <option value="member">Ø¹Ø¶Ùˆ</option>
      <option value="admin">Ø£Ø¯Ù…Ù†</option>
      <option value="owner">Ø£ÙˆÙ†Ø±</option>
    </select>

    <div id="credWrap" class="row-2" style="display:none; margin-top:10px">
      <input id="loginUser" class="input" placeholder="Username">
      <input id="loginPass" class="input" type="password" placeholder="Password">
    </div>

    <button id="enterBtn" class="btn-primary">Ø¯Ø®ÙˆÙ„</button>
  </div>
</section>

<!-- Chat -->
<section id="chat" class="screen">
  <div class="canvas">
    <!-- Header -->
    <header class="hdr">
      <div class="left">
        <button id="stageToggle" class="ib" title="Ø·ÙŠ/ÙØªØ­ Ø§Ù„Ø§Ø³ØªÙŠØ¬">â–¾</button>
      </div>
      <div class="mid">
        <span class="avatar"><img id="avatarImg" src="" alt="avatar"></span>
      </div>
      <div class="right">
        <span id="roleBadge"></span>
        <button id="logoutBtn" class="ib">Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <!-- Messages -->
    <main class="list" id="messages"></main>

    <!-- Stage -->
    <div class="stage-strip" id="stagePanel">
      <div class="slots" id="stage">
        <div class="slot"><div class="lab"></div><div class="ped"></div><div class="bub"><img class="mic-img" alt="mic"></div></div>
        <div class="slot"><div class="lab"></div><div class="ped"></div><div class="bub"><img class="mic-img" alt="mic"></div></div>
        <div class="slot"><div class="lab"></div><div class="ped"></div><div class="bub"><img class="mic-img" alt="mic"></div></div>
        <div class="slot"><div class="lab"></div><div class="ped"></div><div class="bub"><img class="mic-img" alt="mic"></div></div>
        <div class="slot"><div class="lab"></div><div class="ped"></div><div class="bub"><img class="mic-img" alt="mic"></div></div>
      </div>
    </div>

    <!-- Composer -->
    <footer class="composer">
      <div class="pill">
        <button id="emojiBtn" class="btn-ghost" title="Ø¥ÙŠÙ…ÙˆØ¬ÙŠ">ğŸ˜„</button>
        <div id="adminActions" class="chips">
          <button id="dropBtn"   class="btn-chip">ØªÙ†Ø²ÙŠÙ„</button>
          <button id="renameBtn" class="btn-chip">ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…</button>
          <button id="kickBtn"   class="btn-chip danger">Ø·Ø±Ø¯</button>
        </div>
        <input id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..."/>
        <button id="sendBtn" class="btn-r">â¤</button>
      </div>
      <div id="emojiPanel" class="popover"></div>
    </footer>
  </div>
</section>

<script>
/* ====== CONFIG ====== */
const OWNER_PASS='7770', ADMIN_PASS='7771';
function genGuest(){ return 'Ø¶ÙŠÙ-' + Math.floor(1000 + Math.random()*9000); }
const CHAT_KEY='kw777_local_chat',STAGE_KEY='kw777_local_stage',INFO_KEY='kw777_login_info',AVA_KEY='kw777_avatar';

/* Elems */
const roleSel=document.getElementById('role'),credWrap=document.getElementById('credWrap'),enterBtn=document.getElementById('enterBtn');
const logoutBtn=document.getElementById('logoutBtn');
const messages=document.getElementById('messages'),msgInput=document.getElementById('msgInput'),roleBadge=document.getElementById('roleBadge');
const avatarImg=document.getElementById('avatarImg');
const loginAvatar=document.getElementById('loginAvatar'),loginAvatarImg=document.getElementById('loginAvatarImg');
const actionsBar=document.getElementById('adminActions');
const MIC_SRC="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f3a4.svg";
const EMOJIS="ğŸ˜€ğŸ˜„ğŸ˜ğŸ˜…ğŸ˜‚ğŸ¤£ğŸ™‚ğŸ˜‰ğŸ˜ŠğŸ˜ğŸ˜˜ğŸ˜ğŸ¤©ğŸ¥°ğŸ¤—ğŸ™ƒğŸ¤”ğŸ˜´ğŸ˜¤ğŸ˜­ğŸ˜¡ğŸ˜‡ğŸ¤ğŸ‘ğŸ‘ğŸ‘ğŸ™ğŸ”¥âœ¨ğŸ’¯ğŸ‰ğŸğŸ†ğŸ§ğŸ¤ğŸµ".split("");

/* Helpers */
function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active')}
function esc(s){return String(s).replace(/[&<>\"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}
function toggleCred(){const r=roleSel.value;credWrap.style.display=(r==='owner'||r==='admin')?'grid':'none';}
roleSel&&roleSel.addEventListener('change',toggleCred);
const saveInfo=o=>localStorage.setItem(INFO_KEY,JSON.stringify(o));
const loadInfo=_=>{try{return JSON.parse(localStorage.getItem(INFO_KEY)||'{}')}catch{return{}}};
function myName(){ return (loadInfo().name || ''); }

/* Stage helpers */
function removeMyFromStage(){
  const me=myName();
  document.querySelectorAll('#stage .slot.on .lab').forEach(l=>{
    if(l.textContent===me){ l.textContent=''; l.parentElement.classList.remove('on'); }
  });
}
function occupy(slot){
  const me=myName(); if(!me) return;
  const lab=slot.querySelector('.lab');
  if(slot.classList.contains('on') && lab.textContent===me){
    lab.textContent=''; slot.classList.remove('on'); saveStageSnapshot(); return;
  }
  removeMyFromStage();
  slot.classList.add('on'); lab.textContent=me; saveStageSnapshot();
}
function saveStageSnapshot(){ const state=[...document.querySelectorAll('#stage .slot')].map(s=>({on:s.classList.contains('on'),lab:s.querySelector('.lab').textContent||''})); localStorage.setItem(STAGE_KEY, JSON.stringify(state)); }
function restoreStage(){ try{ const state=JSON.parse(localStorage.getItem(STAGE_KEY)||'[]'); const slots=[...document.querySelectorAll('#stage .slot')]; state.forEach((s,i)=>{ if(!slots[i]) return; slots[i].classList.toggle('on',!!s.on); slots[i].querySelector('.lab').textContent=s.lab||''; }); }catch{} }
function clearStage(){ document.querySelectorAll('#stage .slot').forEach(s=>{ s.classList.remove('on'); s.querySelector('.lab').textContent=''; }); localStorage.removeItem(STAGE_KEY); }

/* Chat helpers */
function addRow(from,text,scroll=true){ const row=document.createElement('div'); row.className='msg'; row.innerHTML=`<div class="meta">${esc(from.name)}</div><div class="text">${esc(text)}</div>`; messages.appendChild(row); if(scroll) messages.scrollTop=messages.scrollHeight; }
function saveChat(m){ const arr=JSON.parse(localStorage.getItem(CHAT_KEY)||'[]'); arr.push({name:m.name,text:m.text,ts:Date.now()}); localStorage.setItem(CHAT_KEY, JSON.stringify(arr.slice(-300))); }
function clearChat(){ localStorage.removeItem(CHAT_KEY); messages.innerHTML=''; }

/* Login avatar */
loginAvatar?.addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{ loginAvatarImg.src=r.result; localStorage.setItem(AVA_KEY,r.result); }; r.readAsDataURL(f);
});
document.querySelector('.avatar-lg')?.addEventListener('click',()=>loginAvatar.click());

/* Enter */
enterBtn&&enterBtn.addEventListener('click', ()=>{
  let name=(document.getElementById('displayName').value||'').trim();
  const role=roleSel.value;
  const lp=(document.getElementById('loginPass')?.value||'').trim();
  if(role==='owner'||role==='admin'){
    const ok=(role==='owner')?(lp===OWNER_PASS):(lp===ADMIN_PASS);
    if(!ok){ alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); return; }
    if(!name) name=(role==='owner'?'Ø£ÙˆÙ†Ø±':'Ø£Ø¯Ù…Ù†')+'-'+Math.floor(Math.random()*1000);
  }else{ if(!name) name=genGuest(); }
  saveInfo({name,role});
  show('chat'); bootChat();
});

/* Boot chat */
function bootChat(){
  const info=loadInfo(),name=info.name||'Ù…Ø³ØªØ®Ø¯Ù…',role=info.role||'member';

  // badge
  document.getElementById('roleBadge').innerHTML=role==='owner'?'<span class="badge owner">owner</span>':role==='admin'?'<span class="badge admin">admin</span>':'';
  actionsBar.style.display=(role==='owner'||role==='admin')?'flex':'none';

  // avatar (Ø¹Ø±Ø¶ ÙÙ‚Ø·)
  const savedAva=localStorage.getItem(AVA_KEY);
  avatarImg.src=savedAva||"https://i.ibb.co/4St3gqK/user.png";

  // mics
  document.querySelectorAll('.mic-img').forEach(img=>img.src=MIC_SRC);

  // old messages
  messages.innerHTML='';
  try{ JSON.parse(localStorage.getItem(CHAT_KEY)||'[]').forEach(m=>addRow({name:m.name},m.text,false)); messages.scrollTop=messages.scrollHeight; }catch{}

  // stage binding
  restoreStage();
  document.querySelectorAll('#stage .slot').forEach(slot=>{ slot.addEventListener('click',()=>occupy(slot)); });

  // collapse stage
  const stagePanel=document.getElementById('stagePanel'), stageToggle=document.getElementById('stageToggle'); let collapsed=false;
  stageToggle.onclick=()=>{ collapsed=!collapsed; stagePanel.classList.toggle('collapsed',collapsed); stageToggle.textContent=collapsed?'â–¸':'â–¾'; };

  // ===== Emoji panel (Ù…Ø¹Ø¯Ù‘Ù„) =====
  const emojiBtn   = document.getElementById('emojiBtn');
  const emojiPanel = document.getElementById('emojiPanel');
  emojiPanel.innerHTML = EMOJIS.map(e => `<button type="button">${e}</button>`).join('');
  emojiBtn.onclick = () => { emojiPanel.classList.toggle('show'); };
  function onPick(e){
    const btn = e.target.closest('button');
    if(!btn) return;
    e.preventDefault();
    msgInput.value += btn.textContent;
    msgInput.focus();
    // emojiPanel.classList.remove('show'); // Ù„Ùˆ ØªØ¨ØºÙ‰ ØªÙ‚ÙÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ØŒ Ø§ÙØªØ­ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±
  }
  emojiPanel.addEventListener('pointerdown', onPick, {passive:false});
  emojiPanel.addEventListener('click', onPick);
  document.addEventListener('pointerdown', (e)=>{
    if (!e.target.closest('#emojiPanel') && e.target !== emojiBtn){
      emojiPanel.classList.remove('show');
    }
  });

  // send
  const send=()=>{ const t=(msgInput.value||'').trim(); if(!t) return; saveChat({name,role,text:t}); addRow({name},t,true); msgInput.value=''; };
  document.getElementById('sendBtn').onclick=send; msgInput.addEventListener('keydown',e=>{ if(e.key==='Enter') send(); });

  // admin chips
  document.getElementById('dropBtn')?.addEventListener('click', ()=>{ removeMyFromStage(); saveStageSnapshot(); });
  document.getElementById('renameBtn')?.addEventListener('click', ()=>{ const old=loadInfo().name||''; const nn=prompt('Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:', old); if(!nn) return; saveInfo({...loadInfo(), name:nn}); document.querySelectorAll('#stage .slot.on .lab').forEach(l=>{ if(l.textContent===old) l.textContent=nn; }); addRow({name:'Ø§Ù„Ù†Ø¸Ø§Ù…'},`ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ø¥Ù„Ù‰ ${nn}`,true); });
  document.getElementById('kickBtn')?.addEventListener('click', ()=>{ clearStage(); clearChat(); show('login'); alert('Ø·Ø±Ø¯ (Ù…Ø­Ù„ÙŠ). Ù„Ù„ØªØ²Ø§Ù…Ù† Ù†Ø­ØªØ§Ø¬ Socket.IO'); });

  // logout
  logoutBtn&&(logoutBtn.onclick=()=>{ clearChat(); clearStage(); localStorage.removeItem(INFO_KEY); show('login'); });
}

/* on close */
window.addEventListener('beforeunload', ()=>{ clearChat(); removeMyFromStage(); saveStageSnapshot(); });

/* init */
toggleCred(); (function(){ const a=localStorage.getItem(AVA_KEY); if(a) loginAvatarImg.src=a; })();
</script>
</body>
</html>
