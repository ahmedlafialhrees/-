<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1"/>
  <title>لوحة التحكم</title>
  <style>
    :root{--bg:#0b0f16; --card:#111827; --line:#1d2840; --text:#e8ecf3}
    body{margin:0; background:linear-gradient(180deg,#0e1420,#0b0f16); color:var(--text);
         font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; padding:16px}
    .card{background:linear-gradient(180deg,#111827,#0f1420); border:1px solid var(--line); border-radius:14px; padding:14px; margin-bottom:14px}
    h2{margin:0 0 12px}
    .row{display:flex; gap:8px; flex-wrap:wrap}
    input,select,button{padding:12px;border-radius:12px;border:1px solid var(--line);background:#0c1220;color:#e8ecf3;font-size:16px}
    button{cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:right}
    .del{background:#2a3146;border:1px solid var(--line)}
  </style>
</head>
<body>
  <h2>لوحة التحكم</h2>

  <div class="card">
    <div class="row">
      <input id="uName" type="text" placeholder="اسم المستخدم" style="flex:2"/>
      <input id="uPass" type="text" placeholder="كلمة السر للمستخدم" style="flex:2"/>
      <select id="uRole" style="flex:1">
        <option value="admin">أدمن</option>
        <option value="owner">أونر</option>
      </select>
      <button id="grant" style="flex:1;background:linear-gradient(135deg,#f5c84c,#ffb300);color:#161616;font-weight:700">حفظ/منح</button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">القائمة المحفوظة</h3>
    <table>
      <thead><tr><th>الاسم</th><th>الدور</th><th>إجراء</th></tr></thead>
      <tbody id="rolesBody"></tbody>
    </table>
  </div>

  <div class="row">
    <button onclick="location.href='chat.html'">رجوع للروم</button>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script type="module">
    import { SERVER_URL, OWNER_NAME } from "./config.js?v=3";

    const role = localStorage.getItem("role");
    const name = (localStorage.getItem("name")||"").trim();
    if(!(role==="ownerMain" && name===OWNER_NAME)){ alert("ممنوع — للأونر الرئيسي فقط"); location.href="chat.html"; }

    const socket = io(SERVER_URL, { transports:["websocket"] });
    const rolesBody = document.getElementById("rolesBody");
    const uName = document.getElementById("uName");
    const uPass = document.getElementById("uPass");
    const uRole = document.getElementById("uRole");
    const grant = document.getElementById("grant");

    socket.on("connect", ()=>{
      socket.emit("join", { name, role: "ownerMain" });
      socket.emit("roles:request");
    });

    grant.onclick = ()=>{
      const target=(uName.value||"").trim();
      const pass=(uPass.value||"").trim();
      const role=uRole.value;
      if(!target || !pass){ alert("اكتب الاسم وكلمة السر"); return; }
      socket.emit("roles:grant", { target, role, pass });
      uPass.value="";
      setTimeout(()=> socket.emit("roles:request"), 150);
    };

    socket.on("roles:list",(list)=>{
      rolesBody.innerHTML="";
      list.forEach(({name, role})=>{
        const tr=document.createElement("tr");
        tr.innerHTML = `<td>${name}</td><td>${role}</td><td><button class="del" data-n="${name}">حذف</button></td>`;
        rolesBody.appendChild(tr);
      });
      rolesBody.querySelectorAll(".del").forEach(btn=>{
        btn.onclick=()=> socket.emit("roles:revoke",{ target: btn.dataset.n });
      });
    });

    setInterval(()=> socket.emit("roles:request"), 4000);
  </script>
</body>
</html>
