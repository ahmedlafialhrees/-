<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1"/>
  <title>لوحة التحكم</title>
  <style>
    :root{--bg:#0b0f16; --card:#111827; --line:#1d2840; --text:#e8ecf3}
    body{margin:0; background:linear-gradient(180deg,#0e1420,#0b0f16); color:var(--text);
         font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; padding:16px}

    /* توب بار + زر الرجوع أقصى اليسار */
    .topbar{position:sticky;top:0;z-index:40;height:56px;display:flex;align-items:center;justify-content:space-between;
            padding:8px 12px;margin:-16px -16px 16px;border-bottom:1px solid var(--line);
            background:linear-gradient(180deg,#121a2a,#0f1420)}
    .left{display:flex;align-items:center;gap:8px}
    .backBtn{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0c1220;color:#e8ecf3;cursor:pointer}

    .card{background:linear-gradient(180deg,#111827,#0f1420); border:1px solid var(--line); border-radius:14px; padding:14px; margin-bottom:14px}
    h2{margin:0 0 12px}
    .row{display:flex; gap:8px; flex-wrap:wrap}
    input,select,button{padding:12px;border-radius:12px;border:1px solid var(--line);background:#0c1220;color:#e8ecf3;font-size:16px}
    button{cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:right}
    .del{background:#2a3146;border:1px solid var(--line)}
    .ok{color:#9BE28C;font-size:13px;margin-inline-start:8px}
    .err{color:#ff9d9d;font-size:13px;margin-inline-start:8px}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="left">
      <button class="backBtn" onclick="location.href='chat.html'">رجوع للروم</button>
    </div>
  </div>

  <h2>لوحة التحكم</h2>

  <div class="card">
    <div class="row">
      <input id="uName" type="text" placeholder="اسم المستخدم" style="flex:2"/>
      <input id="uPass" type="text" placeholder="كلمة السر للمستخدم" style="flex:2"/>
      <select id="uRole" style="flex:1">
        <option value="admin">أدمن</option>
        <option value="owner">أونر</option>
      </select>
      <button id="save" style="flex:1;background:linear-gradient(135deg,#f5c84c,#ffb300);color:#161616;font-weight:700">حفظ</button>
      <span id="msg"></span>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">القائمة المحفوظة</h3>
    <table>
      <thead><tr><th>الاسم</th><th>الدور</th><th>إجراء</th></tr></thead>
      <tbody id="rolesBody"></tbody>
    </table>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script type="module">
    import { SERVER_URL, OWNER_NAME } from "./config.js?v=8";

    // حماية الصفحة
    const roleLS = localStorage.getItem("role");
    const nameLS = (localStorage.getItem("name")||"").trim();
    if(!(roleLS==="ownerMain" && nameLS===OWNER_NAME)){ alert("ممنوع — للأونر الرئيسي فقط"); location.href="chat.html"; }

    const socket   = io(SERVER_URL, { transports:["websocket"] });
    const rolesBody= document.getElementById("rolesBody");
    const uName    = document.getElementById("uName");
    const uPass    = document.getElementById("uPass");
    const uRole    = document.getElementById("uRole");
    const saveBtn  = document.getElementById("save");
    const msgEl    = document.getElementById("msg");

    function flash(text, ok=true){
      msgEl.textContent = text;
      msgEl.className = ok ? "ok" : "err";
      setTimeout(()=>{ msgEl.textContent=""; msgEl.className=""; }, 1800);
    }

    function renderList(list){
      rolesBody.innerHTML="";
      list.forEach(({name, role})=>{
        addRow(name, role);
      });
    }

    function addRow(name, role){
      // لو موجود حدّثه
      const old = rolesBody.querySelector(`tr[data-n="${cssEscape(name)}"]`);
      if (old) old.remove();

      const tr = document.createElement("tr");
      tr.dataset.n = name;
      tr.innerHTML = `<td>${escapeHtml(name)}</td><td>${role}</td><td><button class="del">حذف</button></td>`;
      tr.querySelector(".del").onclick = ()=>{
        socket.emit("roles:revoke",{ target:name });
        tr.remove(); // إزالة متفائلة
      };
      rolesBody.prepend(tr); // يظهر فورًا فوق
    }

    function cssEscape(s){ return String(s).replace(/"/g,'\\"'); }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    socket.on("connect", ()=>{
      socket.emit("join", { name: nameLS, role: "ownerMain" });
      socket.emit("roles:request");
    });

    // حفظ + إضافة فورية تحت القائمة
    saveBtn.onclick = ()=>{
      const target=(uName.value||"").trim();
      const pass  =(uPass.value||"").trim();
      const role  = uRole.value;
      if(!target || !pass){ flash("اكتب الاسم وكلمة السر", false); return; }

      // تظهر مباشرة في الجدول (متفائل)
      addRow(target, role);

      // إرسال للسيرفر (يدعم الجديد والقديم)
      const payload = { target, role, pass };
      socket.emit("roles:save",  payload);   // الجديد
      socket.emit("roles:grant", payload);   // توافقية

      // تنظيف خانة السر وتحديث القائمة من السيرفر بعد شوي
      uPass.value="";
      setTimeout(()=> socket.emit("roles:request"), 200);
      flash("تم الحفظ");
    };

    socket.on("roles:list",(list)=> renderList(list));

    // تحديث دوري كضمان
    setInterval(()=> socket.emit("roles:request"), 5000);
  </script>
</body>
</html>
