<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>لوحة التحكم</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="config.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body class="chat-page">
  <div class="topbar">
    <div class="badge">لوحة التحكم</div>
    <a class="btn ghost" href="chat.html">رجوع للشات</a>
  </div>

  <div class="container" style="padding:12px">
    <div class="card">
      <h3 style="margin:0 0 10px">إدارة الصلاحيات</h3>
      <div id="warn" class="badge" style="display:none"></div>
      <div id="list" class="col" style="margin-top:10px"></div>
    </div>
  </div>

  <script>
    const socket = io(window.SERVER_URL, {transports:['websocket']});
    const name = sessionStorage.getItem("loginName") || "";
    const adminPass = sessionStorage.getItem("adminPass") || "";
    const ownerPass = sessionStorage.getItem("ownerPass") || "";
    if (!name){ location.href="index.html"; }
    socket.emit("auth:login", { name, adminPass, ownerPass });

    let me = null;
    socket.on("auth:ok", ({me: my})=>{
      me = my;
      if (me.role !== "owner"){
        document.getElementById('warn').style.display = "inline-flex";
        document.getElementById('warn').textContent = "هذه الصفحة للأونر فقط";
      }
    });
    socket.on("auth:error", ()=> location.href="index.html");

    const list = document.getElementById("list");
    socket.on("users:list", (users)=>{
      list.innerHTML = "";
      users.forEach(u=>{
        const row = document.createElement("div");
        row.className = "owner-list-row";

        const left = document.createElement("div");
        left.innerHTML = `${u.name} ${
          u.role==="owner" ? '<span class="rolechip owner">اونر</span>' :
          u.role==="admin" ? '<span class="rolechip admin">ادمن</span>' : ''
        }`;

        const right = document.createElement("div");
        right.className = "row";

        const btn = (t, fn)=>{ const b=document.createElement("button"); b.className="btn ghost"; b.textContent=t; b.onclick=fn; return b; }
        if (u.role !== "admin") right.appendChild(btn("إعطاء أدمن", ()=> act(u.id,"grantAdmin")));
        if (u.role === "admin") right.appendChild(btn("إزالة أدمن", ()=> act(u.id,"revokeAdmin")));
        if (u.role !== "owner") right.appendChild(btn("إعطاء أونر", ()=> act(u.id,"grantOwner")));
        if (u.role === "owner") right.appendChild(btn("إزالة أونر", ()=> act(u.id,"revokeOwner")));

        row.appendChild(left); row.appendChild(right);
        list.appendChild(row);
      });
    });

    function act(targetId, action){ socket.emit("user:action", { targetId, action }); }
  </script>
</body>
</html>
