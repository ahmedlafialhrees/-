<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>لوحة التحكم</title>
  <link rel="stylesheet" href="style.css"/>
  <script src="config.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <div class="topbar">
    <a class="btn ghost back" href="chat.html">رجوع للشات</a>
    <div class="badge">لوحة التحكم</div>
  </div>

  <div class="container">
    <div id="meInfo" style="margin:8px 0 14px;opacity:.85"></div>

    <div class="card" style="padding:12px">
      <h3 style="margin:6px 0 12px">الأعضاء</h3>
      <div id="list"></div>
    </div>
  </div>

  <script>
    const socket = io(window.SERVER_URL, {transports:['websocket']});
    let me=null;

    (function(){
      const name = sessionStorage.getItem("loginName")||"";
      const adminPass = sessionStorage.getItem("adminPass")||"";
      const ownerPass = sessionStorage.getItem("ownerPass")||"";
      if (!name) { alert("ادخل اسمك أول"); location.href="index.html"; return; }
      socket.emit("auth:login", { name, adminPass, ownerPass });
    })();

    socket.on("auth:ok", ({me: my}) => {
      me = my;
      if (me.role !== "owner" || (window.MAIN_OWNER_NAME && me.name !== window.MAIN_OWNER_NAME)) {
        alert("هذه الصفحة للأونر الرئيسي فقط"); location.href="chat.html"; return;
      }
      document.getElementById("meInfo").textContent = `أنت: ${me.name} — صلاحيتك: Owner`;
    });

    socket.on("auth:error", (m)=>{ alert(m||"خطأ في الدخول"); location.href="index.html"; });
    socket.on("auth:kicked", (m)=>{ alert(m||"تم طردك"); location.href="index.html"; });

    socket.on("users:list", (list)=>{
      const wrap = document.getElementById("list");
      wrap.innerHTML = "";
      list.forEach(u=>{
        const row = document.createElement("div");
        row.className = "owner-list-row";
        row.innerHTML = `
          <div>${u.name} <small style="opacity:.7">(${u.role})</small></div>
          <div class="row">
            ${u.role!=="admin"?'<button class="btn small" data-act="grantAdmin">إعطاء أدمن</button>':'<button class="btn small" data-act="revokeAdmin">إزالة أدمن</button>'}
            ${u.role!=="owner"?'<button class="btn small" data-act="grantOwner">إعطاء أونر</button>':'<button class="btn small" data-act="revokeOwner">إزالة أونر</button>'}
            <button class="btn small" data-act="removeFromStage">إنزال من الاستيج</button>
            <button class="btn small" data-act="kick">طرد</button>
            <button class="btn small" data-act="tempban2h">طرد ساعتين</button>
          </div>
        `;
        row.querySelectorAll("button").forEach(b=>{
          b.onclick = ()=>{
            socket.emit("user:action", { targetId: u.id, action: b.dataset.act });
          };
        });
        wrap.appendChild(row);
      });
    });
  </script>
</body>
</html>
