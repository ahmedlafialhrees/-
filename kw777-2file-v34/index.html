<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>دردشة صوتية — v3.4</title>
<style>
:root{
  --w: 920px;
  --bg1:#0e1220; --bg2:#0b0f1a; --card:#161b2a; --muted:#1e2540; --stroke:#2b3550;
  --text:#eaf0ff; --soft:#a9b1c9; --lav:#b79cff; --lav2:#a487ff; --gold1:#ffd76b; --gold2:#ffb224; --red1:#ff6b6b; --red2:#ff1f1f;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,"SF Pro","Segoe UI",Tahoma,Arial;color:var(--text);background:linear-gradient(180deg,var(--bg1),var(--bg2))}
.canvas{max-width:var(--w);margin:0 auto;padding:8px}
.screen{display:none} .screen.active{display:block}
.badge{font-size:10px;padding:2px 8px;border-radius:999px;margin-right:6px;vertical-align:middle}
.badge.owner{background:linear-gradient(90deg,var(--gold1),var(--gold2));color:#1a1200;box-shadow:0 0 12px rgba(255,197,61,.85);animation:glowGold 1.6s infinite alternate}
.badge.admin{background:linear-gradient(90deg,var(--red1),var(--red2));color:#fff;box-shadow:0 0 12px rgba(255,65,65,.85);animation:glowRed 1.6s infinite alternate}
@keyframes glowGold{from{box-shadow:0 0 6px rgba(255,197,61,.6)}to{box-shadow:0 0 18px rgba(255,197,61,1)}}
@keyframes glowRed{from{box-shadow:0 0 6px rgba(255,65,65,.6)}to{box-shadow:0 0 18px rgba(255,65,65,1)}}
/* Login */
.login-card{width:420px;margin:40px auto;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));backdrop-filter:blur(10px);
  border:1px solid var(--stroke);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.55);padding:18px 16px 24px;position:relative}
.login-card.fixed{height:560px}
.login-card h1{text-align:center;margin:10px 0 12px;font-size:20px}
.login-card .icon{width:64px;height:64px;border-radius:18px;background:#222a3e;display:flex;align-items:center;justify-content:center;margin:6px auto 4px;font-size:28px}
.login-card .x{position:absolute;right:12px;top:10px;color:#1f2330;font-size:13px}
.lab{font-size:12px;color:#cfd6ea;margin:4px 2px}
.inp{width:100%;background:var(--muted);border:1px solid var(--stroke);border-radius:12px;padding:12px;color:#fff;outline:none}
.row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
.btns{display:flex;gap:10px;justify-content:space-between;margin-top:12px}
.btn{border-radius:12px;padding:12px 16px;cursor:pointer;border:1px solid var(--stroke);background:#1b2236;color:#dfe7ff;font-weight:800}
.btn.primary{background:linear-gradient(90deg,var(--lav),var(--lav2));color:#140a2b;border:none}
.btn.ghost{background:transparent}
.btn.danger{background:linear-gradient(90deg,var(--red1),var(--red2));color:#fff;border:none}
.foot{text-align:center;margin-top:8px;color:#9ea9c4;font-size:12px}
/* Header */
.hdr{height:64px;display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#141a2c;border:1px solid var(--stroke);border-radius:12px;margin:6px 0}
.ib{background:#1a2236;border:1px solid var(--stroke);border-radius:12px;color:#cfd6ea;padding:8px 10px;margin-inline-end:6px}
.rname{font-weight:900}
.rsub{opacity:.7;font-size:12px}
/* Stage strip */
.stage-strip{margin:8px 0;background:linear-gradient(180deg,#171d30,#141a2b);border:1px solid var(--stroke);border-radius:14px;padding:10px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
.slots{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;align-items:end;max-width:calc(var(--w) - 40px);margin:0 auto}
.slot{position:relative;text-align:center;padding:10px 6px}
.ped{height:18px;border-radius:9px;background:linear-gradient(90deg,#9a7b2f,#cfa63b,#9a7b2f);box-shadow:0 6px 20px rgba(255,182,70,.35)}
.ped.crown{background:linear-gradient(90deg,#e6bf4b,#ffdf7a,#e6bf4b)}
.bub{width:58px;height:58px;border-radius:50%;margin:6px auto;background:#0c101a;display:flex;align-items:center;justify-content:center;font-size:24px;border:3px solid #000;
  box-shadow:inset 0 0 0 2px #313a5a,0 8px 22px rgba(0,0,0,.45)}
.slot.on .bub{border-color:#d9b356;box-shadow:inset 0 0 0 2px #59461f,0 0 22px rgba(255,220,120,.7)}
.lab{font-size:12px;margin-top:2px;color:#dde4ff}
/* Chat */
.list{padding:12px;display:flex;flex-direction:column;gap:10px;max-height:52vh;overflow:auto}
.row{display:flex;gap:10px}
.av{width:40px;height:40px;border-radius:50%;background:#1b2236;border:1px solid var(--stroke);display:flex;align-items:center;justify-content:center;overflow:hidden}
.imgav{width:40px;height:40px;object-fit:cover}
.emo{font-size:22px}
.bubble{flex:1;background:linear-gradient(180deg,#1a2134,#171d2d);border:1px solid var(--stroke);border-radius:14px;padding:8px 10px}
.meta{display:flex;align-items:center;gap:8px;font-size:12px;margin-bottom:4px}
.nick{font-weight:800}
.txt{line-height:1.7}
.sys{text-align:center;opacity:.85;font-style:italic}
/* Composer */
.composer{position:sticky;bottom:8px;padding:10px 6px;background:transparent;display:flex;justify-content:center}
.pill{width:calc(var(--w) - 80px);max-width:820px;display:flex;align-items:center;gap:8px;background:#1b2236;border:1px solid var(--stroke);border-radius:999px;padding:8px 10px;box-shadow:0 10px 28px rgba(0,0,0,.4)}
.pill input{flex:1;background:transparent;border:none;outline:none;color:#fff}
.btn-l,.btn-r{background:linear-gradient(180deg,#232c45,#1b2338);border:1px solid var(--stroke);color:#e7ecff;border-radius:12px;padding:8px 10px}
/* Action menu */
.menu{position:absolute;z-index:40;background:#131a2b;border:1px solid var(--stroke);border-radius:14px;min-width:210px;padding:8px;box-shadow:0 16px 36px rgba(0,0,0,.5)}
.menu .mt{font-weight:900;margin:6px 8px 10px}
.menu button{display:block;width:100%;background:#1a2236;border:1px solid var(--stroke);border-radius:10px;color:#fff;padding:10px;margin:6px 0}
/* Ticker */
.ticker{position:fixed;top:8px;left:50%;transform:translateX(-50%);background:#131a2b;border:1px solid var(--stroke);border-radius:999px;padding:6px 16px;z-index:50;min-width:260px;max-width:60vw;overflow:hidden}
.ticker span{display:inline-block;white-space:nowrap;animation:marquee 16s linear infinite}
@keyframes marquee{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
.section{border:1px solid var(--stroke);border-radius:14px;background:linear-gradient(180deg,#13192a,#111726);padding:10px}
</style>
</head>
<body>

<section id="login" class="screen active">
  <div class="canvas">
    <div class="login-card fixed">
      <div class="x">إلغاء</div>
      <div class="icon">🎧</div>
      <h1>سجّل الدخول بحسابك</h1>

      <label class="lab">اسمك</label>
      <input id="displayName" class="inp" placeholder="اكتب اسمك"/>

      <label class="lab">الدور</label>
      <select id="role" class="inp">
        <option value="member">عضو</option>
        <option value="admin">أدمن</option>
        <option value="owner">أونر</option>
      </select>

      <div id="accountFields" class="row-2">
        <div><label class="lab">اسم الحساب</label><input id="loginUser" class="inp" placeholder="username"/></div>
        <div><label class="lab">كلمة المرور</label><input id="loginPass" class="inp" type="password" placeholder="••••••"/></div>
      </div>

      <label class="lab">صورتك (اختياري)</label>
      <input id="avatar" class="inp" type="file" accept="image/*"/>

      <div class="btns">
        <button id="goChat" class="btn primary">دخول الشات</button>
        <button id="goControl" class="btn ghost">لوحة التحكم</button>
      </div>
      <div class="foot">الظهور ك متصل</div>
    </div>
  </div>
</section>

<section id="chat" class="screen">
  <div class="canvas">
    <header class="hdr">
      <div class="left">
        <button id="reqStage" class="ib">⤴️</button>
        <button id="leaveStage" class="ib">⤵️</button>
      </div>
      <div class="mid">
        <div class="rname">المطانيخ</div>
        <div class="rsub"></div>
      </div>
      <div class="right" id="roleBadge"></div>
    </header>

    <div class="stage-strip">
      <div class="slots" id="stageRow">
        <div class="slot"><div class="ped crown"></div><div class="bub">🎤</div><div class="lab"></div></div>
        <div class="slot"><div class="ped"></div><div class="bub">🎤</div><div class="lab"></div></div>
        <div class="slot"><div class="ped"></div><div class="bub">🎤</div><div class="lab"></div></div>
        <div class="slot"><div class="ped"></div><div class="bub">🎤</div><div class="lab"></div></div>
        <div class="slot"><div class="ped"></div><div class="bub">🎤</div><div class="lab"></div></div>
      </div>
    </div>

    <div class="section">
      <div id="messages" class="list"></div>
      <div class="composer">
        <div class="pill">
          <button id="emojiBtn" class="btn-l">🙂</button>
          <input id="msgInput" placeholder="اكتب رسالة..."/>
          <button id="sendBtn" class="btn-r">➤</button>
        </div>
      </div>
    </div>
  </div>

  <div id="actionMenu" class="menu" style="display:none">
    <div id="amTitle" class="mt">#-</div>
    <button id="amKick">طرد</button>
    <button id="amPromote">أدمن</button>
    <button id="amRename">تغيير الاسم</button>
    <button id="amClose">إغلاق</button>
  </div>

  <div class="ticker"><span id="tickerText">مرحباً</span></div>
</section>

<section id="control" class="screen">
  <div class="canvas">
    <div class="login-card fixed">
      <h1>لوحة تحكم الأونر الرئيسي</h1>
      <label class="lab">كلمة المرور</label>
      <input id="ownerSecret" class="inp" type="password" placeholder="66773707"/>
      <div class="btns"><button id="loadBtn" class="btn primary">تحميل المستخدمين</button></div>

      <h3>إضافة/تعديل</h3>
      <div class="row-2">
        <div><label class="lab">اسم المستخدم</label><input id="aUser" class="inp" placeholder="مثال: admin2"/></div>
        <div><label class="lab">كلمة المرور</label><input id="aPass" class="inp" placeholder="مثال: 1234"/></div>
        <div><label class="lab">الدور</label>
          <select id="aRole" class="inp"><option value="admin">أدمن</option><option value="owner">أونر</option></select>
        </div>
      </div>
      <div class="btns">
        <button id="saveBtn" class="btn primary">حفظ/إضافة</button>
        <button id="deleteBtn" class="btn danger">حذف</button>
      </div>

      <h3>القائمة</h3>
      <div id="list" class="section"></div>
    </div>
  </div>
</section>

<script src="/socket.io/socket.io.js"></script>
<script>
function show(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }

const roleSel = document.getElementById('role');
const goChat = document.getElementById('goChat');
const goControl = document.getElementById('goControl');
const fields = document.getElementById('accountFields');

function toggleFields(){
  const r = roleSel.value;
  if(r==='member'){ fields.style.display='none'; goControl.style.display='none'; }
  else {
    fields.style.display='grid';
    const u = document.getElementById('loginUser').value||'';
    const p = document.getElementById('loginPass').value||'';
    goControl.style.display = (r==='owner' && u==='owner' && p==='66773707') ? 'inline-block' : 'none';
  }
}
['change','input'].forEach(ev=>{
  roleSel.addEventListener(ev, toggleFields);
  ['loginUser','loginPass'].forEach(id=>document.getElementById(id).addEventListener(ev, toggleFields));
});
toggleFields();

function readAvatarFile(){
  return new Promise(resolve=>{
    const f = document.getElementById('avatar').files[0];
    if(!f){ resolve(null); return; }
    const fr = new FileReader(); fr.onload = e=> resolve(e.target.result); fr.readAsDataURL(f);
  });
}

goChat.addEventListener('click', async ()=>{
  const displayName = (document.getElementById('displayName').value||'مستخدم').trim();
  const role = roleSel.value;
  const loginUser = (document.getElementById('loginUser').value||'').trim();
  const loginPass = (document.getElementById('loginPass').value||'').trim();
  const avatar = await readAvatarFile() || '🙂';
  localStorage.setItem('displayName', displayName);
  localStorage.setItem('role', role);
  localStorage.setItem('loginUser', loginUser);
  localStorage.setItem('loginPass', loginPass);
  localStorage.setItem('avatar', avatar);
  show('chat'); initChatOnce();
});
goControl.addEventListener('click', ()=>{ show('control'); });

let chatBooted = false;
function initChatOnce(){ if(chatBooted) return; chatBooted = true;

  const displayName = localStorage.getItem('displayName')||'مستخدم';
  const role = localStorage.getItem('role')||'member';
  const loginUser = localStorage.getItem('loginUser')||'';
  const loginPass = localStorage.getItem('loginPass')||'';
  const avatar = localStorage.getItem('avatar')||'🙂';

  const badgeBox = document.getElementById('roleBadge');
  if(role==='owner') badgeBox.innerHTML = '<span class="badge owner">owner</span>';
  else if(role==='admin') badgeBox.innerHTML = '<span class="badge admin">admin</span>';

  const socket = io();
  socket.emit('join', { displayName, role, avatarDataUrl: avatar, loginUser, loginPass, room:'الاستقبال' });

  const messages = document.getElementById('messages');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');
  const tickerText = document.getElementById('tickerText');
  const reqStage = document.getElementById('reqStage');
  const leaveStage = document.getElementById('leaveStage');

  let myUid=null; socket.on('joined', ({uid})=> myUid=uid);
  socket.on('auth:fail', ()=>{ alert('الدخول بهذا الدور غير صحيح'); show('login'); });

  socket.on('welcome', ({ text })=>{ const s=document.createElement('div'); s.className='sys'; s.textContent=text; messages.appendChild(s); messages.scrollTop=messages.scrollHeight; });

  sendBtn.addEventListener('click', ()=>{ const t=msgInput.value.trim(); if(!t) return; socket.emit('chat:msg',{text:t}); msgInput.value=''; });
  msgInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendBtn.click(); });

  socket.on('chat:msg', ({ from, text })=>{
    const row = document.createElement('div'); row.className='row';
    const badge = (from.role==='owner')?'<span class="badge owner">owner</span>':(from.role==='admin')?'<span class="badge admin">admin</span>':'';
    const avatarHtml = from.avatar && from.avatar.startsWith('data:') ? `<img class="imgav" src="${from.avatar}"/>` : `<span class="emo">${from.avatar||'🙂'}</span>`;
    row.innerHTML = `<div class="av">${avatarHtml}</div><div class="bubble"><div class="meta"><span class="nick">${from.name} ${badge}</span><span class="id">#${from.uid}</span></div><div class="txt">${esc(text)}</div></div>`;
    messages.appendChild(row); messages.scrollTop=messages.scrollHeight;
  });
  socket.on('system:msg', ({ text })=>{ const s=document.createElement('div'); s.className='sys'; s.textContent=text; messages.appendChild(s); messages.scrollTop=messages.scrollHeight; });
  socket.on('ticker:update', ({ from, text })=>{ tickerText.textContent = `${from.name}: ${text}`; });

  const slots = Array.from(document.querySelectorAll('#stageRow .slot')).map(el=>({ el, lab: el.querySelector('.lab'), bub: el.querySelector('.bub') }));
  socket.on('stage:update', (speakers)=>{
    slots.forEach(s=>{ s.lab.innerHTML=''; s.bub.textContent='🎤'; s.el.classList.remove('on'); });
    speakers.slice(0,5).forEach((sp,i)=>{
      const badge = (sp.role==='owner')?'<span class="badge owner">owner</span>':(sp.role==='admin')?'<span class="badge admin">admin</span>':'';
      slots[i].lab.innerHTML = `${sp.name} ${badge}`;
      slots[i].el.classList.add('on');
    });
  });
  socket.on('stage:dropped', ()=> addSys('تم إنزالك من الاستيج'));
  function addSys(t){ const d=document.createElement('div'); d.className='sys'; d.textContent=t; messages.appendChild(d); messages.scrollTop=messages.scrollHeight; }

  reqStage.addEventListener('click', ()=> socket.emit('stage:request'));
  leaveStage.addEventListener('click', ()=> socket.emit('stage:leave'));

  const menu = document.getElementById('actionMenu');
  const amTitle = document.getElementById('amTitle');
  const amKick = document.getElementById('amKick');
  const amPromote = document.getElementById('amPromote');
  const amRename = document.getElementById('amRename');
  const amClose = document.getElementById('amClose');
  let targetUid=null;

  document.getElementById('messages').addEventListener('click', (e)=>{
    const meta = e.target.closest('.meta'); if(!meta) return;
    const m = meta.querySelector('.id').textContent.match(/#(\d+)/); if(!m) return;
    targetUid = parseInt(m[1],10);
    amTitle.textContent = meta.querySelector('.nick').textContent;
    const r = meta.getBoundingClientRect();
    menu.style.left = (r.left+window.scrollX)+'px';
    menu.style.top = (r.bottom+window.scrollY+6)+'px';
    menu.style.display = 'block';
  });
  amClose.addEventListener('click', ()=> menu.style.display='none');
  document.addEventListener('click', (e)=>{ if(menu.style.display==='block' && !e.target.closest('#actionMenu') && !e.target.closest('.meta')) menu.style.display='none'; });
  amKick.addEventListener('click', ()=>{ socket.emit('admin:kick',{targetUid}); menu.style.display='none'; });
  amPromote.addEventListener('click', ()=>{ socket.emit('admin:promote',{targetUid}); menu.style.display='none'; });
  amRename.addEventListener('click', ()=>{ const nn=prompt('اكتب الاسم الجديد:'); if(nn && nn.trim()) socket.emit('owner:rename',{targetUid,newName:nn.trim()}); menu.style.display='none'; });
}

async function api(path, method='GET', body){
  const s = document.getElementById('ownerSecret').value||'';
  const res = await fetch(path, { method, headers:{'Content-Type':'application/json','X-Owner-Secret':s}, body: method==='GET'?undefined:JSON.stringify(body||{}) });
  if(!res.ok) throw new Error(await res.text()||('HTTP '+res.status));
  return await res.json();
}
document.getElementById('loadBtn').addEventListener('click', async ()=>{
  try{
    const data = await api('/api/accounts');
    const list = document.getElementById('list'); list.innerHTML='';
    data.accounts.forEach(acc=>{
      const row = document.createElement('div'); row.className='row'; row.style.justifyContent='space-between';
      row.innerHTML = `<div>${acc.username}</div><div>${acc.role}</div>`;
      row.onclick = ()=>{ aUser.value=acc.username; aPass.value=acc.password; aRole.value=acc.role; };
      list.appendChild(row);
    });
  }catch(e){ alert('خطأ: '+e.message); }
});
document.getElementById('saveBtn').addEventListener('click', async ()=>{
  const u=aUser.value.trim(), p=aPass.value.trim(), r=aRole.value;
  if(!u||!p) return alert('اكتب الاسم وكلمة المرور');
  try{ try{ await api('/api/accounts/'+encodeURIComponent(u),'PUT',{username:u,password:p,role:r}); }catch{ await api('/api/accounts','POST',{username:u,password:p,role:r}); }
    alert('تم الحفظ'); loadBtn.click();
  }catch(e){ alert('فشل: '+e.message); }
});
document.getElementById('deleteBtn').addEventListener('click', async ()=>{
  const u=aUser.value.trim(); if(!u) return alert('اكتب الاسم');
  try{ await api('/api/accounts/'+encodeURIComponent(u),'DELETE'); alert('تم الحذف'); loadBtn.click(); }
  catch(e){ alert('فشل: '+e.message); }
});

function esc(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;","\\\"":"&quot;","'":"&#39;"}[c])); }
</script>
</body>
</html>
